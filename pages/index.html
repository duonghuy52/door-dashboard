<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Door Pro</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- MQTT.js -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>

<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col p-4 md:p-10 font-sans">

    <!-- ================= HEADER ================= -->
    <header class="text-center mb-10">
        <h1 class="text-4xl font-black text-blue-600 tracking-tight">
            SMART DOOR CONTROL
        </h1>
        <div class="h-1 w-20 bg-blue-600 mx-auto mt-2 rounded-full"></div>
    </header>

    <!-- ================= ƒêI·ªÄU KHI·ªÇN + TR·∫†NG TH√ÅI ================= -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-4xl mx-auto w-full mb-12">

        <!-- OPEN -->
        <button onclick="sendCmd('OPEN')"
            class="group bg-white hover:bg-emerald-50 border-2 border-emerald-500
                   active:scale-95 transition-all p-8 rounded-[24px] shadow-xl
                   flex flex-col items-center">
            <span class="text-5xl mb-2 group-hover:rotate-12 transition-transform">üîì</span>
            <span class="text-2xl font-black text-emerald-600">OPEN</span>
        </button>

        <!-- CLOSE -->
        <button onclick="sendCmd('CLOSE')"
            class="group bg-white hover:bg-rose-50 border-2 border-rose-500
                   active:scale-95 transition-all p-8 rounded-[24px] shadow-xl
                   flex flex-col items-center">
            <span class="text-5xl mb-2 group-hover:-rotate-12 transition-transform">üîí</span>
            <span class="text-2xl font-black text-rose-600">CLOSE</span>
        </button>

        <!-- TR·∫†NG TH√ÅI -->
        <div class="bg-white p-6 rounded-[24px] shadow-xl border border-gray-100
                    flex flex-col items-center justify-center">
            <div id="doorEmoji" class="text-5xl mb-2">‚ùì</div>
            <div class="text-sm text-gray-500 mb-2">Tr·∫°ng th√°i c·ª≠a</div>
            <div id="doorStatusText"
                 class="text-2xl font-black text-gray-600">--</div>
            <div id="lastUpdate"
                 class="text-xs text-gray-400 mt-2">--</div>
        </div>
    </div>

    <!-- ================= TH·ªêNG K√ä ================= -->
    <div class="max-w-4xl mx-auto w-full bg-white p-8 rounded-[40px]
                shadow-2xl border border-gray-100">

        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <h2 class="text-2xl font-black text-gray-700 uppercase tracking-widest italic">
                üìä Th·ªëng k√™ d·ªØ li·ªáu
            </h2>

            <div class="flex items-center gap-2 bg-gray-100 p-2 rounded-2xl">
                <input type="date" id="datePicker"
                       onchange="getStats()"
                       class="bg-transparent font-bold text-blue-600 outline-none p-1">
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-emerald-50 p-10 rounded-[30px] text-center border-2 border-emerald-100">
                <p class="text-emerald-600 font-black text-xl mb-4 uppercase">S·ªë l·∫ßn M·ªû</p>
                <p id="openCnt"
                   class="text-5xl md:text-7xl font-black text-emerald-700 italic">--</p>
            </div>

            <div class="bg-rose-50 p-10 rounded-[30px] text-center border-2 border-rose-100">
                <p class="text-rose-600 font-black text-xl mb-4 uppercase">S·ªë l·∫ßn ƒê√ìNG</p>
                <p id="closeCnt"
                   class="text-5xl md:text-7xl font-black text-rose-700 italic">--</p>
            </div>
        </div>
    </div>

    <!-- ================= SCRIPT ================= -->
    <script>
        // Ng√†y m·∫∑c ƒë·ªãnh h√¥m nay
        document.getElementById('datePicker').valueAsDate = new Date();

        // MQTT HiveMQ WebSocket
        const client = mqtt.connect('wss://broker.hivemq.com:8884/mqtt');

        client.on('connect', () => {
            console.log('MQTT connected');
            client.subscribe('door/state');
        });

        client.on('message', (topic, message) => {
            const msg = message.toString();
            if (topic === 'door/state') updateDoorState(msg);
        });

        function sendCmd(cmd) {
            client.publish('door/command', cmd);
            console.log('Send:', cmd);
        }

        function updateDoorState(state) {
            const textEl = document.getElementById('doorStatusText');
            const emojiEl = document.getElementById('doorEmoji');
            const timeEl = document.getElementById('lastUpdate');

            if (state === 'OPEN') {
                textEl.innerText = 'M·ªü';
                textEl.className = 'text-2xl font-black text-emerald-600';
                emojiEl.innerText = 'üîì';
            } else if (state === 'CLOSE') {
                textEl.innerText = 'ƒê√≥ng';
                textEl.className = 'text-2xl font-black text-rose-600';
                emojiEl.innerText = 'üîí';
            }

            timeEl.innerText = 'C·∫≠p nh·∫≠t: ' + new Date().toLocaleString();
        }

        async function getStats() {
            const date = document.getElementById('datePicker').value;
            const res = await fetch(`/api/door/stats?date=${date}`);
            const data = await res.json();

            if (data.success) {
                document.getElementById('openCnt').innerText = data.stats.opens;
                document.getElementById('closeCnt').innerText = data.stats.closes;
            }
        }

        window.onload = getStats;
        setInterval(getStats, 15000);
    </script>
</body>
</html>
